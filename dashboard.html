<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apparatus Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f4f7fa;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .station {
      background: #fff;
      border: 2px solid #007acc;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .station-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: -0.5rem -0.5rem 0.5rem -0.5rem;
      padding: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: #007acc;
      cursor: grab;
      border-bottom: 1px solid #d4e2f0;
      background: rgba(0, 122, 204, 0.05);
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
    }

    .station-header:active {
      cursor: grabbing;
    }

    .station-body {
      padding-top: 0.25rem;
    }

    .apparatus {
      padding: 0.5rem;
      margin: 0.25rem 0;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      color: white;
      cursor: grab;
      background: #444;
      position: relative;
      overflow: hidden;
    }

    .ghost {
      opacity: 0.2;
      cursor: default;
    }

    .red { background: #d32f2f !important; }
    .green { background: #388e3c !important; }
    .blue { background: #1976d2 !important; }
    .yellow { background: #fbc02d !important; color: #1f1f1f !important; }
    .purple { background: #6a1b9a !important; }
    .black { background: #212121 !important; }
    .apparatus.reserve::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: inherit;
      background-image: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,0.22) 0,
        rgba(255,255,255,0.22) 8px,
        transparent 8px,
        transparent 16px
      );
    }

    .admin-btn {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
    }

    #adminModal, #editModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal-content {
      background: linear-gradient(180deg, #ffffff 0%, #f7faff 100%);
      width: min(92vw, 560px);
      margin: 5% auto;
      padding: 1.5rem;
      border-radius: 12px;
      position: relative;
      box-shadow: 0 18px 40px rgba(15, 40, 75, 0.25);
      box-sizing: border-box;
      max-height: min(92vh, 760px);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .tabs {
      display: flex;
      margin-bottom: 1rem;
      border-bottom: 1px solid #ccc;
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: none;
      background: none;
      font-weight: bold;
      color: #4a6278;
      transition: color 0.12s ease, border-color 0.12s ease;
    }

    .tab:hover {
      color: #0f3460;
    }

    .tab.active {
      border-bottom: 3px solid #007acc;
      color: #007acc;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .tab-header {
      margin-bottom: 1rem;
    }

    .tab-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: #0f3460;
    }

    .tab-header p {
      margin: 0.25rem 0 0;
      color: #4a6278;
      font-size: 0.9rem;
    }

    .row {
      display: flex;
      gap: 0.75rem;
      align-items: stretch;
      margin-bottom: 0.75rem;
      padding: 0.75rem;
      border-radius: 10px;
      border: 1px solid #dbe5f3;
      background: #f7f9fc;
    }

    .row-body {
      display: flex;
      flex: 1 1 auto;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .row-body.column {
      flex-direction: column;
      gap: 0.5rem;
    }

    .row-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: flex-end;
      gap: 0.5rem;
      flex: 0 0 auto;
    }

    .row-actions button {
      min-width: 96px;
    }

    .data-actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .data-note {
      color: #4a6278;
      font-size: 0.85rem;
    }

    .import-label {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0.85rem;
      font-weight: 600;
      border-radius: 6px;
      background: #1f2933;
      color: #fff;
      cursor: pointer;
    }

    .import-label:hover {
      box-shadow: 0 4px 12px rgba(31, 41, 51, 0.3);
    }

    .import-label input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .row input,
    .row select {
      flex: 1 1 auto;
      min-width: 0;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      flex: 1 1 160px;
      min-width: 0;
    }

    .row-body.column .field {
      flex: 0 0 auto;
    }

    .edit-fields {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    #editModal .edit-fields .field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      margin-bottom: 0.5rem;
      flex: none;
    }

    #editModal .edit-fields .field:last-child {
      margin-bottom: 0;
    }

    .checkbox-field {
      flex-direction: row !important;
      align-items: center;
      gap: 0.5rem !important;
    }

    .checkbox-field input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .checkbox-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #0f3460;
      text-transform: none;
      letter-spacing: normal;
    }

    .field-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: #4f6a86;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .scrollable {
      border: 1px solid #dbe5f3;
      padding: 0.75rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      background: #ffffff;
    }

    input, select, textarea {
      width: 100%;
      margin: 0;
      box-sizing: border-box;
      font-size: 1rem;
    }

    .row input,
    .row select {
      box-sizing: border-box;
      height: 36px !important;
      min-height: 36px !important;
      max-height: 36px !important;
      padding: 6px 10px !important;
      line-height: 22px !important;
    }

    .modal-content input[type="text"],
    .modal-content input[type="number"],
    .modal-content input[type="tel"],
    .modal-content input[type="search"],
    .modal-content select {
      border: 1px solid #bcd0eb;
      border-radius: 6px;
      background: #fff;
      display: inline-flex;
      align-items: center;
      appearance: none;
      -moz-appearance: none;
      -webkit-appearance: none;
    }

    .modal-content select {
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%233c5780' stroke-width='1.3' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.45rem center;
      background-size: 10px 6px;
      padding-right: 1.6rem;
    }

    .modal-content textarea {
      padding: 0.45rem 0.55rem;
      min-height: 3.25rem;
      border: 1px solid #bcd0eb;
      border-radius: 6px;
      resize: vertical;
    }


    button {
      background: #0f83ff;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(15, 131, 255, 0.3);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    button.danger {
      background: #f05252;
      box-shadow: none;
    }

    button.danger:hover {
      box-shadow: 0 4px 12px rgba(240, 82, 82, 0.28);
    }

    button.secondary {
      background: #1f2933;
    }

    button.secondary:hover {
      box-shadow: 0 4px 12px rgba(31, 41, 51, 0.3);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .modal-actions button {
      min-width: 120px;
    }

    .tab-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 0.5rem;
      gap: 0.5rem;
    }

    .hidden {
      display: none !important;
    }

    .add-row {
      border-style: dashed;
      border-color: #9db8dd;
      background: rgba(221, 233, 255, 0.4);
    }

    .add-row input,
    .add-row select {
      background: #fff;
    }

    @media (max-width: 720px) {
      .modal-content {
        width: min(96vw, 560px);
        padding: 1.25rem;
      }

    }

    @media (max-width: 600px) {
      .modal-content {
        width: calc(100vw - 1.5rem);
        padding: 1rem;
        margin: 1.5rem auto;
      }

      .row {
        flex-direction: column;
        align-items: stretch;
      }

      .row button {
        width: 100%;
        align-self: stretch;
      }

      .modal-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .modal-actions button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Fire Department Apparatus Dashboard</h1>
  <button class="admin-btn" onclick="openAdminModal()">Admin</button>
  <div class="grid" id="stationGrid"></div>
<!-- Apparatus Edit Modal -->
  <div id="editModal">
    <div class="modal-content">
      <h3 id="editModalTitle" style="margin: 0 0 1rem; font-size: 1.25rem; color: #0f3460;">Edit Apparatus</h3>
      <div class="edit-fields">
        <label class="field">
          <span class="field-label">ID</span>
          <input type="text" id="editId" />
        </label>
        <label class="field">
          <span class="field-label">Apparatus Type</span>
          <select id="editType"></select>
        </label>
        <label class="field checkbox-field">
          <input type="checkbox" id="editReserve" />
          <span class="checkbox-label">Reserve</span>
        </label>
        <label class="field">
          <span class="field-label">Home Station</span>
          <select id="editHomeStation"></select>
        </label>
        <label class="field">
          <span class="field-label">Current Station</span>
          <select id="editStation"></select>
        </label>
        <label class="field">
          <span class="field-label">Notes</span>
          <textarea id="editNotes" rows="3"></textarea>
        </label>
      </div>
      <div class="modal-actions">
        <button onclick="saveApparatusEdit()">Save</button>
        <button class="secondary" onclick="closeEditModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Admin Modal with Tabs -->
  <div id="adminModal">
    <div class="modal-content">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('stations')">Stations</button>
        <button class="tab" onclick="switchTab('apparatus')">Apparatus</button>
        <button class="tab" onclick="switchTab('data')">Data</button>
      </div>

      <div id="stations" class="tab-content active">
        <div class="tab-header">
          <h2>Stations</h2>
          <p>Manage station names and grid order.</p>
        </div>
        <div class="scrollable" id="stationList"></div>
        <div id="stationAdder" class="row add-row hidden">
          <label class="field">
            <span class="field-label">Station Name</span>
            <input type="text" id="stationAdderName" placeholder="Station 9" />
          </label>
          <div class="modal-actions">
            <button id="stationAdderConfirm" type="button">Save Station</button>
            <button id="stationAdderCancel" class="secondary" type="button">Cancel</button>
          </div>
        </div>
        <div class="tab-footer">
          <button id="stationShowAdder" type="button">Add Station</button>
          <button class="secondary" type="button" onclick="closeAdminModal()">Exit</button>
        </div>
      </div>

      <div id="apparatus" class="tab-content">
        <div class="tab-header">
          <h2>Apparatus</h2>
          <p>Add or update units, their types, and assignments.</p>
        </div>
        <div class="scrollable" id="apparatusList"></div>
        <div id="apparatusAdder" class="row add-row hidden">
          <div class="row-body column">
            <label class="field">
              <span class="field-label">Number</span>
              <input type="text" id="apparatusAdderNumber" placeholder="4527" />
            </label>
            <label class="field">
              <span class="field-label">ID (optional)</span>
              <input type="text" id="apparatusAdderId" placeholder="E1" />
            </label>
            <label class="field">
              <span class="field-label">Type</span>
              <select id="apparatusAdderType"></select>
            </label>
            <label class="field checkbox-field">
              <input type="checkbox" id="apparatusAdderReserve" />
              <span class="checkbox-label">Reserve</span>
            </label>
            <label class="field">
              <span class="field-label">Notes (optional)</span>
              <input type="text" id="apparatusAdderNotes" placeholder="Ready reserve" />
            </label>
            <label class="field">
              <span class="field-label">Home Station</span>
              <select id="apparatusAdderHome"></select>
            </label>
            <label class="field">
              <span class="field-label">Current Station</span>
              <select id="apparatusAdderStation"></select>
            </label>
          </div>
          <div class="row-actions">
            <button id="apparatusAdderConfirm" type="button">Save Apparatus</button>
            <button id="apparatusAdderCancel" class="secondary" type="button">Cancel</button>
          </div>
        </div>
        <div class="tab-footer">
          <button id="apparatusShowAdder" type="button">Add Apparatus</button>
          <button class="secondary" type="button" onclick="closeAdminModal()">Exit</button>
        </div>
      </div>

      <div id="data" class="tab-content">
        <div class="tab-header">
          <h2>Data</h2>
          <p>Export or import station and apparatus data for backups or transfers.</p>
        </div>
        <div class="data-actions">
          <button id="backupButton" type="button">Export JSON</button>
          <label class="import-label">
            <input id="importInput" type="file" accept="application/json" />
            <span>Import JSON</span>
          </label>
        </div>
        <p class="data-note">Export creates a JSON file containing both stations and apparatus arrays. Import replaces existing data with the uploaded backup.</p>
      </div>
    </div>
  </div>
<script>
  const STATION_KEY = "stations";
  const APPARATUS_KEY = "apparatus";
  const TYPE_TO_CLASS = {
    Fire: "red",
    Aid: "green",
    Medic: "blue",
    AT: "yellow",
    Staff: "purple",
    Utility: "black"
  };
  const APPARATUS_TYPES = Object.keys(TYPE_TO_CLASS);
  const DEFAULT_TYPE = "Utility";

  let editingNumber = null;
  let draggingApparatus = null;
  let draggingStation = null;
  const isTouchDevice = "ontouchstart" in window || navigator.maxTouchPoints > 0;
  const adminModalEl = document.getElementById("adminModal");
  const editModalEl = document.getElementById("editModal");
  const editModalTitle = document.getElementById("editModalTitle");
  const editIdInput = document.getElementById("editId");
  const editTypeSelect = document.getElementById("editType");
  const editReserveCheckbox = document.getElementById("editReserve");
  const editHomeSelect = document.getElementById("editHomeStation");
  const editStationSelect = document.getElementById("editStation");
  const editNotesInput = document.getElementById("editNotes");
  const stationListEl = document.getElementById("stationList");
  const apparatusListEl = document.getElementById("apparatusList");
  const stationAdderRow = document.getElementById("stationAdder");
  const stationAdderNameInput = document.getElementById("stationAdderName");
  const stationAdderConfirmBtn = document.getElementById("stationAdderConfirm");
  const stationAdderCancelBtn = document.getElementById("stationAdderCancel");
  const stationShowAdderBtn = document.getElementById("stationShowAdder");
  const apparatusAdderRow = document.getElementById("apparatusAdder");
  const apparatusAdderNumberInput = document.getElementById("apparatusAdderNumber");
  const apparatusAdderIdInput = document.getElementById("apparatusAdderId");
  const apparatusAdderTypeSelect = document.getElementById("apparatusAdderType");
  const apparatusAdderReserveCheckbox = document.getElementById("apparatusAdderReserve");
  const apparatusAdderNotesInput = document.getElementById("apparatusAdderNotes");
  const apparatusAdderHomeSelect = document.getElementById("apparatusAdderHome");
  const apparatusAdderStationSelect = document.getElementById("apparatusAdderStation");
  const apparatusAdderConfirmBtn = document.getElementById("apparatusAdderConfirm");
  const apparatusAdderCancelBtn = document.getElementById("apparatusAdderCancel");
  const apparatusShowAdderBtn = document.getElementById("apparatusShowAdder");
  const backupButton = document.getElementById("backupButton");
  const importInput = document.getElementById("importInput");

  let bodyScrollLockCount = 0;
  let previousBodyOverflow = "";
  const DEFAULT_ADMIN_TAB = "stations";
  let lastAddedStationId = null;
  let lastAddedApparatusNumber = null;

  function lockBodyScroll() {
    if (bodyScrollLockCount === 0) {
      previousBodyOverflow = document.body.style.overflow || "";
      document.body.style.overflow = "hidden";
    }
    bodyScrollLockCount += 1;
  }

  function unlockBodyScroll() {
    if (bodyScrollLockCount > 0) {
      bodyScrollLockCount -= 1;
      if (bodyScrollLockCount === 0) {
        document.body.style.overflow = previousBodyOverflow;
      }
    }
  }

  if (stationShowAdderBtn) {
    stationShowAdderBtn.addEventListener("click", showStationAdder);
  }
  if (stationAdderCancelBtn) {
    stationAdderCancelBtn.addEventListener("click", hideStationAdder);
  }
  if (stationAdderConfirmBtn) {
    stationAdderConfirmBtn.addEventListener("click", confirmAddStation);
  }
  if (stationAdderNameInput) {
    stationAdderNameInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        confirmAddStation();
      }
    });
  }
  if (apparatusShowAdderBtn) {
    apparatusShowAdderBtn.addEventListener("click", showApparatusAdder);
  }
  if (apparatusAdderCancelBtn) {
    apparatusAdderCancelBtn.addEventListener("click", hideApparatusAdder);
  }
  if (apparatusAdderConfirmBtn) {
    apparatusAdderConfirmBtn.addEventListener("click", confirmAddApparatus);
  }
  [apparatusAdderNumberInput, apparatusAdderIdInput, apparatusAdderNotesInput].forEach(input => {
    if (input) {
      input.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          confirmAddApparatus();
        }
      });
    }
  });

  if (backupButton) {
    backupButton.addEventListener("click", exportDataBackup);
  }

  if (importInput) {
    importInput.addEventListener("change", handleDataImport);
  }

  [adminModalEl, editModalEl].forEach(modal => {
    if (!modal) return;
    modal.addEventListener("click", event => {
      if (event.target === modal) {
        if (modal === adminModalEl) {
          closeAdminModal();
        } else if (modal === editModalEl) {
          closeEditModal();
        }
      }
    });
  });

  document.addEventListener("keydown", event => {
    if (event.key === "Escape") {
      if (editModalEl && editModalEl.style.display === "block") {
        closeEditModal();
      } else if (adminModalEl && adminModalEl.style.display === "block") {
        closeAdminModal();
      }
    }
  });

  function switchTab(tabId) {
    document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
    const tabButton = document.querySelector(`.tab[onclick*="${tabId}"]`);
    const targetContent = document.getElementById(tabId);
    if (tabButton) tabButton.classList.add("active");
    if (targetContent) targetContent.classList.add("active");
  }

  function ensureLocalStorage() {
    if (!localStorage.getItem(STATION_KEY)) {
      localStorage.setItem(STATION_KEY, JSON.stringify([]));
    }
    if (!localStorage.getItem(APPARATUS_KEY)) {
      localStorage.setItem(APPARATUS_KEY, JSON.stringify([]));
    }
  }

  function migrateStations(stations) {
    let dirty = false;
    const migrated = stations.map((station, index) => {
      const next = { ...station };
      if (!next.stationId && next.id) {
        next.stationId = next.id;
        delete next.id;
        dirty = true;
      }
      if (typeof next.order !== "number") {
        next.order = index;
        dirty = true;
      }
      return next;
    });
    return { stations: migrated, dirty };
  }

  function migrateApparatus(apparatus) {
    let dirty = false;
    const colorToType = {
      red: "Fire",
      green: "Aid",
      blue: "Medic",
      yellow: "AT",
      purple: "Staff",
      black: "Utility"
    };

    const migrated = apparatus.map(app => {
      const next = { ...app };
      if (!next.apparatusNumber && next.number) {
        next.apparatusNumber = next.number;
        delete next.number;
        dirty = true;
      }
      if (!next.stationId && next.currentStation) {
        next.stationId = next.currentStation;
        delete next.currentStation;
        dirty = true;
      }
      if (!next.homeStationId && next.homeStation) {
        next.homeStationId = next.homeStation;
        delete next.homeStation;
        dirty = true;
      }
      if (!next.apparatusType) {
        if (next.color && colorToType[next.color]) {
          next.apparatusType = colorToType[next.color];
        } else {
          next.apparatusType = DEFAULT_TYPE;
        }
        dirty = true;
      }
      if (!APPARATUS_TYPES.includes(next.apparatusType)) {
        next.apparatusType = DEFAULT_TYPE;
        dirty = true;
      }
      if (next.color) {
        delete next.color;
        dirty = true;
      }
      // Migrate old reserve logic: if no ID, set reserve to true
      if (typeof next.reserve !== "boolean") {
        next.reserve = !next.id;
        dirty = true;
      }
      return next;
    });
    return { apparatus: migrated, dirty };
  }

  function loadData() {
    ensureLocalStorage();
    let stations = JSON.parse(localStorage.getItem(STATION_KEY));
    let apparatus = JSON.parse(localStorage.getItem(APPARATUS_KEY));

    const stationMigration = migrateStations(stations);
    stations = stationMigration.stations.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

    const apparatusMigration = migrateApparatus(apparatus);
    apparatus = apparatusMigration.apparatus;

    if (stationMigration.dirty) {
      saveStations(stations);
    }
    if (apparatusMigration.dirty) {
      saveApparatus(apparatus);
    }

    return { stations, apparatus };
  }

  function saveStations(stations) {
    localStorage.setItem(STATION_KEY, JSON.stringify(stations));
  }

  function saveApparatus(apparatus) {
    localStorage.setItem(APPARATUS_KEY, JSON.stringify(apparatus));
  }

  function getColorClass(apparatusType) {
    return TYPE_TO_CLASS[apparatusType] || TYPE_TO_CLASS[DEFAULT_TYPE];
  }

  function populateTypeSelect(selectOrId, selectedType = DEFAULT_TYPE) {
    const select = typeof selectOrId === "string" ? document.getElementById(selectOrId) : selectOrId;
    if (!select) return;
    select.innerHTML = "";
    APPARATUS_TYPES.forEach(type => {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type;
      if (type === selectedType) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  }

  function populateStationSelect(selectOrId, stations, selectedStation, placeholderLabel = "Unassigned", optionPrefix = "") {
    const select = typeof selectOrId === "string" ? document.getElementById(selectOrId) : selectOrId;
    if (!select) return;
    select.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = placeholderLabel;
    select.appendChild(placeholder);

    stations.forEach(station => {
      const option = document.createElement("option");
      option.value = station.stationId;
      option.textContent = optionPrefix ? `${optionPrefix} ${station.name}` : station.name;
      if (station.stationId === selectedStation) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  }

  function buildField(labelText, element) {
    const wrapper = document.createElement("label");
    wrapper.className = "field";
    const label = document.createElement("span");
    label.className = "field-label";
    label.textContent = labelText;
    wrapper.appendChild(label);
    wrapper.appendChild(element);
    return wrapper;
  }

  function showStationAdder() {
    if (!stationAdderRow || !stationShowAdderBtn) return;
    const { stations } = loadData();
    stationAdderRow.classList.remove("hidden");
    stationShowAdderBtn.disabled = true;
    if (stationAdderNameInput) {
      stationAdderNameInput.value = `Station ${stations.length + 1}`;
      stationAdderNameInput.focus();
      stationAdderNameInput.select();
    }
  }

  function hideStationAdder() {
    if (stationAdderRow) {
      stationAdderRow.classList.add("hidden");
    }
    if (stationAdderNameInput) {
      stationAdderNameInput.value = "";
    }
    if (stationShowAdderBtn) {
      stationShowAdderBtn.disabled = false;
    }
  }

  function confirmAddStation() {
    const name = stationAdderNameInput ? stationAdderNameInput.value.trim() : "";
    if (!name) {
      alert("Please provide a station name.");
      if (stationAdderNameInput) {
        stationAdderNameInput.focus();
      }
      return;
    }

    const { stations } = loadData();
    const id = "s" + Math.floor(Math.random() * 100000);
    const order = stations.length;
    const updated = [...stations, { stationId: id, name, order }];
    saveStations(updated);
    lastAddedStationId = id;
    hideStationAdder();
    openAdminModal();
    renderDashboard();
  }

  function showApparatusAdder() {
    if (!apparatusAdderRow || !apparatusShowAdderBtn) return;
    const { stations } = loadData();
    apparatusAdderRow.classList.remove("hidden");
    apparatusShowAdderBtn.disabled = true;
    populateTypeSelect(apparatusAdderTypeSelect, DEFAULT_TYPE);
    populateStationSelect(apparatusAdderHomeSelect, stations, stations[0]?.stationId || "", "Home: Unassigned", "Home:");
    populateStationSelect(
      apparatusAdderStationSelect,
      stations,
      stations[0]?.stationId || "",
      "Current: Unassigned",
      "At:"
    );
    if (apparatusAdderNumberInput) {
      apparatusAdderNumberInput.value = "";
      apparatusAdderNumberInput.focus();
    }
    if (apparatusAdderIdInput) apparatusAdderIdInput.value = "";
    if (apparatusAdderNotesInput) apparatusAdderNotesInput.value = "";
  }

  function hideApparatusAdder() {
    if (apparatusAdderRow) {
      apparatusAdderRow.classList.add("hidden");
    }
    if (apparatusShowAdderBtn) {
      apparatusShowAdderBtn.disabled = false;
    }
    if (apparatusAdderNumberInput) apparatusAdderNumberInput.value = "";
    if (apparatusAdderIdInput) apparatusAdderIdInput.value = "";
    if (apparatusAdderReserveCheckbox) apparatusAdderReserveCheckbox.checked = false;
    if (apparatusAdderNotesInput) apparatusAdderNotesInput.value = "";
  }

  function confirmAddApparatus() {
    const number = apparatusAdderNumberInput ? apparatusAdderNumberInput.value.trim() : "";
    if (!number) {
      alert("Apparatus number is required.");
      if (apparatusAdderNumberInput) {
        apparatusAdderNumberInput.focus();
      }
      return;
    }

    const idValue = apparatusAdderIdInput ? apparatusAdderIdInput.value.trim() : "";
    const typeValue = apparatusAdderTypeSelect ? apparatusAdderTypeSelect.value : DEFAULT_TYPE;
    const reserveValue = apparatusAdderReserveCheckbox ? apparatusAdderReserveCheckbox.checked : false;
    const notesValue = apparatusAdderNotesInput ? apparatusAdderNotesInput.value.trim() : "";
    const homeStationValue = apparatusAdderHomeSelect ? apparatusAdderHomeSelect.value : "";
    const stationValue = apparatusAdderStationSelect
      ? apparatusAdderStationSelect.value || homeStationValue
      : homeStationValue;

    const { apparatus } = loadData();
    if (apparatus.some(a => a.apparatusNumber === number)) {
      alert("Apparatus number must be unique.");
      if (apparatusAdderNumberInput) {
        apparatusAdderNumberInput.focus();
      }
      return;
    }

    const updated = [
      ...apparatus,
      {
        apparatusNumber: number,
        id: idValue,
        apparatusType: typeValue || DEFAULT_TYPE,
        reserve: reserveValue,
        notes: notesValue,
        homeStationId: homeStationValue,
        stationId: stationValue
      }
    ];
    saveApparatus(updated);
    lastAddedApparatusNumber = number;
    hideApparatusAdder();
    openAdminModal();
    renderDashboard();
  }

  function exportDataBackup() {
    const data = loadData();
    const payload = {
      stations: data.stations,
      apparatus: data.apparatus,
      exportedAt: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const stamp = new Date().toISOString().replace(/[:.]/g, "-");
    const link = document.createElement("a");
    link.href = url;
    link.download = `apparatus-backup-${stamp}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function handleDataImport(event) {
    const input = event.target;
    const file = input.files && input.files[0];
    if (!file) return;

    if (!confirm("Importing will replace all existing stations and apparatus data. This cannot be undone. Continue?")) {
      input.value = "";
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const text = e.target?.result;
        const parsed = JSON.parse(text);
        if (!parsed || !Array.isArray(parsed.stations) || !Array.isArray(parsed.apparatus)) {
          alert("Invalid backup file. Expected stations and apparatus arrays.");
          return;
        }
        localStorage.setItem(STATION_KEY, JSON.stringify(parsed.stations));
        localStorage.setItem(APPARATUS_KEY, JSON.stringify(parsed.apparatus));
        lastAddedStationId = null;
        lastAddedApparatusNumber = null;
        openAdminModal();
        renderDashboard();
        alert("Import complete. Data has been replaced with the backup file.");
      } catch (err) {
        console.error(err);
        alert("Unable to import backup. Please verify the JSON file and try again.");
      } finally {
        input.value = "";
      }
    };
    reader.onerror = () => {
      alert("Failed to read file. Please try again.");
      input.value = "";
    };
    reader.readAsText(file);
  }

  function closeAdminModal() {
    hideStationAdder();
    hideApparatusAdder();
    if (adminModalEl && adminModalEl.style.display === "block") {
      adminModalEl.style.display = "none";
      unlockBodyScroll();
    }
  }

  function renderDashboard() {
    const { stations, apparatus } = loadData();
    const grid = document.getElementById("stationGrid");
    grid.innerHTML = "";

    stations.forEach(station => {
      const card = document.createElement("div");
      card.className = "station";
      card.dataset.stationId = station.stationId;

      const header = document.createElement("div");
      header.className = "station-header";
      header.textContent = station.name;
      if (!isTouchDevice) {
        header.setAttribute("draggable", "true");
        header.addEventListener("dragstart", e => {
          draggingStation = station.stationId;
          e.dataTransfer.effectAllowed = "move";
        });
        header.addEventListener("dragend", () => {
          draggingStation = null;
        });
      } else {
        header.removeAttribute("draggable");
      }

      const body = document.createElement("div");
      body.className = "station-body";

      if (!isTouchDevice) {
        card.addEventListener("dragover", e => {
          if (draggingApparatus || draggingStation) {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
          }
        });

        card.addEventListener("drop", e => {
          e.preventDefault();
          if (draggingApparatus) {
            const updated = apparatus.map(app => {
              if (app.apparatusNumber === draggingApparatus) {
                const updatedApp = { ...app, stationId: station.stationId };
                // If reserve apparatus is moved to home station, clear the ID
                if (updatedApp.reserve && updatedApp.homeStationId === station.stationId) {
                  updatedApp.id = "";
                }
                return updatedApp;
              }
              return app;
            });
            draggingApparatus = null;
            saveApparatus(updated);
            renderDashboard();
          } else if (draggingStation && draggingStation !== station.stationId) {
            const reordered = [...stations];
            const fromIndex = reordered.findIndex(s => s.stationId === draggingStation);
            if (fromIndex > -1) {
              const [moved] = reordered.splice(fromIndex, 1);
              const targetIndex = reordered.findIndex(s => s.stationId === station.stationId);
              if (targetIndex > -1) {
                reordered.splice(targetIndex, 0, moved);
                const tagged = reordered.map((s, index) => ({ ...s, order: index }));
                saveStations(tagged);
                renderDashboard();
              }
            }
            draggingStation = null;
          }
        });
      }

      const stationApparatus = apparatus.filter(app => app.stationId === station.stationId);
      const stationApparatusIndexed = stationApparatus.map((app, index) => ({ app, index }));
      const sortedStationApparatus = stationApparatusIndexed
        .slice()
        .sort((a, b) => {
          const aReserve = a.app.reserve;
          const bReserve = b.app.reserve;
          if (aReserve && !bReserve) return 1;
          if (!aReserve && bReserve) return -1;
          if (aReserve && bReserve) {
            return a.app.apparatusNumber.localeCompare(b.app.apparatusNumber, undefined, { numeric: true, sensitivity: "base" });
          }
          return a.index - b.index;
        })
        .map(entry => entry.app);
      const homeGhosts = apparatus.filter(app => app.homeStationId === station.stationId && app.stationId !== station.stationId);

      sortedStationApparatus.forEach(app => {
        const box = document.createElement("div");
        const colorClass = getColorClass(app.apparatusType);
        box.className = `apparatus ${colorClass}`;
        box.textContent = app.id ? `${app.id} ${app.apparatusNumber}` : app.apparatusNumber;

        if (!isTouchDevice) {
          box.setAttribute("draggable", "true");
          box.addEventListener("dragstart", e => {
            draggingApparatus = app.apparatusNumber;
            e.dataTransfer.effectAllowed = "move";
          });
          box.addEventListener("dragend", () => {
            draggingApparatus = null;
          });
        } else {
          box.removeAttribute("draggable");
        }

        if (app.reserve) {
          box.classList.add("reserve");
        }

        box.addEventListener("click", e => {
          if (draggingApparatus) return;
          openEditModal(app);
        });

        if (isTouchDevice) {
          box.addEventListener(
            "touchend",
            e => {
              if (draggingApparatus) return;
              e.preventDefault();
              openEditModal(app);
            },
            { passive: false }
          );
        }

        body.appendChild(box);
      });

      homeGhosts.forEach(app => {
        const ghost = document.createElement("div");
        const colorClass = getColorClass(app.apparatusType);
        ghost.className = `apparatus ghost ${colorClass}`;
        ghost.textContent = app.id ? `${app.id} ${app.apparatusNumber}` : app.apparatusNumber;
        if (app.reserve) {
          ghost.classList.add("reserve");
        }
        body.appendChild(ghost);
      });

      card.appendChild(header);
      card.appendChild(body);
      grid.appendChild(card);
    });
  }

  function openEditModal(app) {
    const { stations } = loadData();
    editingNumber = app.apparatusNumber;
    if (editModalTitle) {
      editModalTitle.textContent = app.apparatusNumber ? `Edit ${app.apparatusNumber}` : "Edit Apparatus";
    }
    if (editIdInput) {
      editIdInput.value = app.id || "";
    }
    if (editReserveCheckbox) {
      editReserveCheckbox.checked = app.reserve || false;
    }
    if (editNotesInput) {
      editNotesInput.value = app.notes || "";
    }
    populateTypeSelect(editTypeSelect, app.apparatusType);
    populateStationSelect(editHomeSelect, stations, app.homeStationId || "", "Unassigned");
    populateStationSelect(editStationSelect, stations, app.stationId || "", "Unassigned");

    // Add change handler to Current Station dropdown to clear ID when reserve apparatus returns home
    if (editStationSelect) {
      editStationSelect.onchange = () => {
        // If reserve apparatus is moved to home station, clear the ID
        if (editReserveCheckbox && editReserveCheckbox.checked &&
            editHomeSelect && editStationSelect.value === editHomeSelect.value) {
          if (editIdInput) {
            editIdInput.value = "";
          }
        }
      };
    }

    if (editModalEl) {
      const wasHidden = editModalEl.style.display !== "block";
      editModalEl.style.display = "block";
      if (wasHidden) {
        lockBodyScroll();
      }
    }

    // Add Enter key handler for edit modal inputs
    const editModalKeyHandler = (e) => {
      if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
        e.preventDefault();
        saveApparatusEdit();
      }
    };

    editModalEl.addEventListener("keydown", editModalKeyHandler);
    // Store handler so we can remove it later
    editModalEl._keyHandler = editModalKeyHandler;
  }

  function closeEditModal() {
    editingNumber = null;
    if (editModalEl && editModalEl.style.display === "block") {
      editModalEl.style.display = "none";
      unlockBodyScroll();
      // Remove the Enter key handler
      if (editModalEl._keyHandler) {
        editModalEl.removeEventListener("keydown", editModalEl._keyHandler);
        editModalEl._keyHandler = null;
      }
    }
  }

  function saveApparatusEdit() {
    const id = editIdInput ? editIdInput.value.trim() : "";
    const apparatusType = editTypeSelect ? editTypeSelect.value : DEFAULT_TYPE;
    const reserve = editReserveCheckbox ? editReserveCheckbox.checked : false;
    const homeStationId = editHomeSelect ? editHomeSelect.value : "";
    const stationId = editStationSelect ? editStationSelect.value : "";
    const notes = editNotesInput ? editNotesInput.value.trim() : "";

    const { apparatus } = loadData();
    const updated = apparatus.map(app => {
      if (app.apparatusNumber === editingNumber) {
        return {
          ...app,
          id,
          apparatusType,
          reserve,
          homeStationId: homeStationId || "",
          stationId: stationId || "",
          notes
        };
      }
      return app;
    });

    saveApparatus(updated);
    closeEditModal();
    renderDashboard();
  }

  function openAdminModal() {
    const wasHidden = !adminModalEl || adminModalEl.style.display !== "block";
    const { stations, apparatus } = loadData();

    hideStationAdder();
    hideApparatusAdder();

    if (apparatusAdderTypeSelect) {
      populateTypeSelect(apparatusAdderTypeSelect, DEFAULT_TYPE);
    }
    if (apparatusAdderHomeSelect) {
      populateStationSelect(apparatusAdderHomeSelect, stations, "", "Home: Unassigned", "Home:");
    }
    if (apparatusAdderStationSelect) {
      populateStationSelect(apparatusAdderStationSelect, stations, "", "Current: Unassigned", "At:");
    }

    if (stationListEl) {
      stationListEl.innerHTML = "";
      stations.forEach((station, index) => {
        const row = document.createElement("div");
        row.className = "row";

      const body = document.createElement("div");
      body.className = "row-body column";

        const nameInput = document.createElement("input");
        nameInput.value = station.name;
        nameInput.placeholder = "Station name";
        nameInput.onchange = () => {
          station.name = nameInput.value;
          saveStations(stations);
          del.setAttribute("aria-label", `Delete ${station.name}`);
          renderDashboard();
        };
        const nameField = buildField("Name", nameInput);

      body.appendChild(nameField);

        const del = document.createElement("button");
        del.textContent = "Delete";
        del.classList.add("danger");
        del.setAttribute("aria-label", `Delete ${station.name}`);
        del.onclick = () => {
          const hasApparatus = apparatus.some(app => app.stationId === station.stationId || app.homeStationId === station.stationId);
          if (hasApparatus) {
            alert("Cannot delete station with assigned apparatus.");
            return;
          }
          if (!confirm(`Are you sure you want to delete ${station.name}?`)) {
            return;
          }
          stations.splice(index, 1);
          const reordered = stations.map((s, idx) => ({ ...s, order: idx }));
          saveStations(reordered);
          openAdminModal();
          renderDashboard();
        };

        const actions = document.createElement("div");
        actions.className = "row-actions";
        actions.appendChild(del);

        row.appendChild(body);
        row.appendChild(actions);
        stationListEl.appendChild(row);

        if (lastAddedStationId === station.stationId) {
          setTimeout(() => {
            nameInput.focus();
            row.scrollIntoView({ behavior: "smooth", block: "center" });
          }, 0);
          lastAddedStationId = null;
        }
      });
    }

    if (apparatusListEl) {
      apparatusListEl.innerHTML = "";
      apparatus.forEach((app, index) => {
        const row = document.createElement("div");
        row.className = "row";

        const rowContent = document.createElement("div");
        rowContent.className = "row-body";

        const numberInput = document.createElement("input");
        numberInput.value = app.apparatusNumber;
        numberInput.placeholder = "Number";
        numberInput.onchange = () => {
          const trimmed = numberInput.value.trim();
          if (!trimmed) {
            alert("Apparatus number is required.");
            numberInput.value = app.apparatusNumber;
            return;
        }
        const duplicate = apparatus.some((other, otherIndex) => otherIndex !== index && other.apparatusNumber === trimmed);
        if (duplicate) {
          alert("Apparatus number must be unique.");
          numberInput.value = app.apparatusNumber;
          return;
        }
        app.apparatusNumber = trimmed;
        saveApparatus(apparatus);
        del.setAttribute("aria-label", `Delete apparatus ${app.apparatusNumber}`);
        renderDashboard();
      };
        const numberField = buildField("Number", numberInput);
        rowContent.appendChild(numberField);

        const idInput = document.createElement("input");
        idInput.value = app.id || "";
        idInput.placeholder = "ID (optional)";
        idInput.onchange = () => {
          app.id = idInput.value.trim();
          saveApparatus(apparatus);
          renderDashboard();
        };
        const idField = buildField("ID", idInput);
        rowContent.appendChild(idField);

        const typeSelect = document.createElement("select");
        APPARATUS_TYPES.forEach(type => {
          const opt = document.createElement("option");
          opt.value = type;
          opt.textContent = type;
          if (app.apparatusType === type) opt.selected = true;
          typeSelect.appendChild(opt);
        });
        typeSelect.onchange = () => {
          app.apparatusType = typeSelect.value;
          saveApparatus(apparatus);
          renderDashboard();
        };
        const typeField = buildField("Type", typeSelect);
        rowContent.appendChild(typeField);

        const reserveCheckbox = document.createElement("input");
        reserveCheckbox.type = "checkbox";
        reserveCheckbox.checked = app.reserve || false;
        reserveCheckbox.onchange = () => {
          app.reserve = reserveCheckbox.checked;
          saveApparatus(apparatus);
          renderDashboard();
        };
        const reserveLabel = document.createElement("label");
        reserveLabel.className = "field checkbox-field";
        reserveLabel.appendChild(reserveCheckbox);
        const reserveText = document.createElement("span");
        reserveText.className = "checkbox-label";
        reserveText.textContent = "Reserve";
        reserveLabel.appendChild(reserveText);
        rowContent.appendChild(reserveLabel);

        const notesInput = document.createElement("input");
        notesInput.value = app.notes || "";
        notesInput.placeholder = "Notes (optional)";
        notesInput.onchange = () => {
          app.notes = notesInput.value;
          saveApparatus(apparatus);
        };
        const notesField = buildField("Notes", notesInput);
        rowContent.appendChild(notesField);

        const homeSelect = document.createElement("select");
        populateStationSelect(homeSelect, stations, app.homeStationId, "Home: Unassigned", "Home:");
        homeSelect.onchange = () => {
          app.homeStationId = homeSelect.value;
          saveApparatus(apparatus);
          renderDashboard();
        };
        const homeField = buildField("Home", homeSelect);
        rowContent.appendChild(homeField);

        const stationSelect = document.createElement("select");
        populateStationSelect(stationSelect, stations, app.stationId, "Current: Unassigned", "At:");
        stationSelect.onchange = () => {
          app.stationId = stationSelect.value;
          // If reserve apparatus is moved to home station, clear the ID
          if (app.reserve && app.homeStationId === stationSelect.value) {
            app.id = "";
            idInput.value = "";
          }
          saveApparatus(apparatus);
          renderDashboard();
        };
        const currentField = buildField("Current", stationSelect);
        rowContent.appendChild(currentField);

        const del = document.createElement("button");
        del.textContent = "Delete";
        del.classList.add("danger");
        del.setAttribute("aria-label", `Delete apparatus ${app.apparatusNumber}`);
        del.onclick = () => {
          const displayName = app.id ? `${app.id} (${app.apparatusNumber})` : app.apparatusNumber;
          if (!confirm(`Are you sure you want to delete apparatus ${displayName}?`)) {
            return;
          }
          apparatus.splice(index, 1);
          saveApparatus(apparatus);
          openAdminModal();
          renderDashboard();
        };

        const actions = document.createElement("div");
        actions.className = "row-actions";
        actions.appendChild(del);

        row.appendChild(rowContent);
        row.appendChild(actions);
        apparatusListEl.appendChild(row);

        if (lastAddedApparatusNumber === app.apparatusNumber) {
          setTimeout(() => {
            numberInput.focus();
            row.scrollIntoView({ behavior: "smooth", block: "center" });
          }, 0);
          lastAddedApparatusNumber = null;
        }
      });
    }

    if (adminModalEl) {
      adminModalEl.style.display = "block";
      if (wasHidden) {
        lockBodyScroll();
      }
      // Reset scroll position on the modal content
      const modalContent = adminModalEl.querySelector(".modal-content");
      if (modalContent) {
        modalContent.scrollTop = 0;
      }
    }

    switchTab(DEFAULT_ADMIN_TAB);

    // Reset scroll position to top of scrollable lists
    if (stationListEl) {
      stationListEl.scrollTop = 0;
    }
    if (apparatusListEl) {
      apparatusListEl.scrollTop = 0;
    }
  }



  renderDashboard();
</script>
</body>
</html>
